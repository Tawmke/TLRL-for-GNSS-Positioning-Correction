import numpy as np
from ple.games.catcher import Catcher
from ple import PLE
import os

######## catcher ########
def get_ob(state):
    return np.array([state['player_x'], state['player_vel'], state['fruit_x'], state['fruit_y']])

def get_ob_normalize(state):
    np_state = np.array([state['player_x'], state['player_vel'], state['fruit_x'], state['fruit_y']])
    np_state[0] = (np_state[0] - 26) / 26
    np_state[1] = (np_state[1]) / 8
    np_state[2] = (np_state[2] - 26) / 26
    np_state[3] = (np_state[3] - 20) / 45
    return np_state

class catcher():
    def __init__(self, init_lives=3):
        self.catcherOb = Catcher(init_lives=init_lives)
        self.pOb = PLE(self.catcherOb, fps=30, state_preprocessor=get_ob_normalize, display_screen=False)
        self.num_action = 2
        self.actions = self.pOb.getActionSet()
        self.num_state = 4
        self.pOb.init()

    def setseed(self, value):
        self.pOb.rng.seed(value)
        return 0

    def reset(self):
        self.pOb.reset_game()
        return self.pOb.getGameState()

    def step(self, a):
        reward = self.pOb.act(self.actions[a])
        terminal = self.pOb.game_over()
        return (self.pOb.getGameState(), reward, terminal, {})

    def close(self):
        return


######## catcher-3 actions ########
# def catcher3_get_ob(state):
#    return np.array([state['player_x'], state['player_vel'], state['fruit_x'], state['fruit_y']])

class catcher3():
    def __init__(self, init_lives=3, normalize=True, display=False):
        self.catcherOb = Catcher(init_lives=init_lives)
        if display is False:
            # do not open a pygame window
            os.putenv('SDL_VIDEODRIVER', 'fbcon')
            os.environ["SDL_VIDEODRIVER"] = "dummy"

        if normalize:
            self.pOb = PLE(self.catcherOb, fps=30, state_preprocessor=get_ob_normalize, display_screen=display)
        else:
            self.pOb = PLE(self.catcherOb, fps=30, state_preprocessor=get_ob, display_screen=display)
        self.actions = [100, 97, None] # self.pOb.getActionSet()
        self.num_action = 3
        self.num_state = 4
        self.pOb.init()

    def _get_image(self):
        '''
        return a np array with shape = [64, 64, 3]
        '''
        return self.pOb.getScreenGrayscale()

    def setseed(self, value):
        self.pOb.rng.seed(value)
        return 0

    def reset(self):
        self.pOb.reset_game()
        return self.pOb.getGameState()

    def step(self, a):
        reward = self.pOb.act(self.actions[a])
        terminal = self.pOb.game_over()
        return (self.pOb.getGameState(), reward, terminal, {})

    def close(self):
        return
